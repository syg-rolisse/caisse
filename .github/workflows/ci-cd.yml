name: Caisse CI/CD Pipeline

on:
  push:
    branches:
      - develop
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  test-and-build:
    name: ðŸ§ª Tester l'application (avec la config de Staging)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: CrÃ©er les fichiers .env pour les tests
        run: |
          echo "CrÃ©ation des .env pour le backend et la BDD..."
          echo "${{ secrets.STAGING_ENV_APIS }}" > ./apis/.env
          echo "${{ secrets.STAGING_ENV_DB }}" > ./apis/.env.db
          echo "CrÃ©ation du .env pour le frontend..."
          echo "${{ secrets.STAGING_ENV_APPS }}" > ./apps/.env

      - name: Lancer Docker Compose pour les tests
        run: docker compose -f docker-compose.staging.yml up --build -d

      - name: VÃ©rifier l'Ã©tat des conteneurs
        run: |
          echo "Attente de 20s pour la stabilisation des services..."
          sleep 20
          docker compose -f docker-compose.staging.yml ps
          if [ $(docker compose -f docker-compose.staging.yml ps | grep -E "Up|running" | wc -l) -lt $(docker compose -f docker-compose.staging.yml ps -q | wc -l) ]; then
            echo "::error::Un ou plusieurs conteneurs n'ont pas dÃ©marrÃ© correctement."
            docker compose -f docker-compose.staging.yml logs
            exit 1
          fi
          echo "Tests d'intÃ©gration rÃ©ussis."

  deploy-staging:
    name: ðŸš€ DÃ©ployer sur Staging
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Supprimer l'ancien dossier de Staging sur le VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Suppression de l'ancien dossier /opt/caisse-staging..."
            rm -rf /opt/caisse-staging

      - name: Copier les nouveaux fichiers sur le VPS de Staging
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "."
          target: "/opt/caisse-staging"

      - name: DÃ©ployer l'application sur Staging
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /opt/caisse-staging
            
            echo "CrÃ©ation des fichiers .env pour l'environnement de staging..."
            echo "${{ secrets.STAGING_ENV_APIS }}" > ./apis/.env
            echo "${{ secrets.STAGING_ENV_DB }}" > ./apis/.env.db
            echo "${{ secrets.STAGING_ENV_APPS }}" > ./apps/.env
            echo "${{ secrets.STAGING_ENV_BACKOFFICE }}" > ./backoffice/.env
            
            echo "ArrÃªt et suppression forcÃ©s des anciens conteneurs de staging..."
            docker stop caisse_staging_backoffice caisse_staging_apps caisse_staging_apis caisse_staging_db || true
            docker rm caisse_staging_backoffice caisse_staging_apps caisse_staging_apis caisse_staging_db || true
            
            echo "Reconstruction des images de staging sans cache..."
            docker compose -f docker-compose.staging.yml build --no-cache
            
            echo "DÃ©marrage des nouveaux services de staging..."
            docker compose -f docker-compose.staging.yml -p caisse_staging up -d
            
            echo "Nettoyage des anciennes images Docker..."
            docker image prune -f

  deploy-production:
    name: ðŸš€ DÃ©ployer sur Production
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Supprimer l'ancien dossier de Production sur le VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Suppression de l'ancien dossier /opt/caisse-prod..."
            rm -rf /opt/caisse-prod

      - name: Copier les nouveaux fichiers sur le VPS de Production
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "."
          target: "/opt/caisse-prod"

      - name: DÃ©ployer l'application sur Production
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /opt/caisse-prod
            
            echo "CrÃ©ation des fichiers .env pour l'environnement de production..."
            echo "${{ secrets.PRODUCTION_ENV_APIS }}" > ./apis/.env
            echo "${{ secrets.PRODUCTION_ENV_DB }}" > ./apis/.env.db
            echo "${{ secrets.PRODUCTION_ENV_APPS }}" > ./apps/.env
            echo "${{ secrets.PRODUCTION_ENV_BACKOFFICE }}" > ./backoffice/.env
            
            echo "ArrÃªt et suppression forcÃ©s des anciens conteneurs de production..."
            docker stop caisse_prod_backoffice caisse_prod_apps caisse_prod_apis caisse_prod_db || true
            docker rm caisse_prod_backoffice caisse_prod_apps caisse_prod_apis caisse_prod_db || true
            
            echo "Reconstruction des images de production sans cache..."
            docker compose -f docker-compose.prod.yml build --no-cache
            
            echo "DÃ©marrage des nouveaux services de production..."
            docker compose -f docker-compose.prod.yml -p caisse_prod up -d
            
            echo "Nettoyage des anciennes images Docker..."
            docker image prune -f
            
            